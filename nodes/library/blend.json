{
  "id": "BLEND",
  "label": "Blend",
  "category": "Color",
  "locales": {
    "zh": {
      "Blend": "混合",
      "Blends two images together using various blend modes.": "使用多种混合模式将两个图像混合在一起。",
      "Background": "背景",
      "Foreground": "前景",
      "Opacity": "不透明度",
      "Mode": "混合模式",
      "Normal": "正常",
      "Darken": "变暗",
      "Multiply": "正片叠底",
      "Color Burn": "颜色加深",
      "Lighten": "变亮",
      "Screen": "滤色",
      "Color Dodge": "颜色减淡",
      "Overlay": "叠加",
      "Soft Light": "柔光",
      "Hard Light": "强光",
      "Difference": "差值",
      "Exclusion": "排除",
      "Add": "相加",
      "Subtract": "相减",
      "Divide": "相除"
    }
  },
  "data": {
    "glsl": [
      "float blendColorDodge(float base, float blend) {",
      "    return (blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0);",
      "}",
      "",
      "float blendColorBurn(float base, float blend) {",
      "    return (blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0);",
      "}",
      "",
      "vec3 blendColorDodge(vec3 base, vec3 blend) {",
      "    return vec3(blendColorDodge(base.r, blend.r), blendColorDodge(base.g, blend.g), blendColorDodge(base.b, blend.b));",
      "}",
      "",
      "vec3 blendColorBurn(vec3 base, vec3 blend) {",
      "    return vec3(blendColorBurn(base.r, blend.r), blendColorBurn(base.g, blend.g), blendColorBurn(base.b, blend.b));",
      "}",
      "",
      "vec3 blendOverlay(vec3 base, vec3 blend) {",
      "    return mix(2.0 * base * blend, 1.0 - 2.0 * (1.0 - base) * (1.0 - blend), step(0.5, base));",
      "}",
      "",
      "vec3 blendSoftLight(vec3 base, vec3 blend) {",
      "    return mix(",
      "        2.0 * base * blend + base * base * (1.0 - 2.0 * blend),",
      "        sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend),",
      "        step(0.5, blend)",
      "    );",
      "}",
      "",
      "void run(vec2 uv, vec4 background, vec4 foreground, float opacity, int mode, out vec4 result) {",
      "    vec4 bg = background;",
      "    vec4 fg = foreground;",
      "    ",
      "    vec3 b = bg.rgb;",
      "    vec3 f = fg.rgb;",
      "    vec3 outCol = f;",
      "    ",
      "    if (mode == 0) { // Normal",
      "        outCol = f;",
      "    } else if (mode == 1) { // Darken",
      "        outCol = min(b, f);",
      "    } else if (mode == 2) { // Multiply",
      "        outCol = b * f;",
      "    } else if (mode == 3) { // Color Burn",
      "        outCol = blendColorBurn(b, f);",
      "    } else if (mode == 4) { // Lighten",
      "        outCol = max(b, f);",
      "    } else if (mode == 5) { // Screen",
      "        outCol = 1.0 - (1.0 - b) * (1.0 - f);",
      "    } else if (mode == 6) { // Color Dodge",
      "        outCol = blendColorDodge(b, f);",
      "    } else if (mode == 7) { // Overlay",
      "        outCol = blendOverlay(b, f);",
      "    } else if (mode == 8) { // Soft Light",
      "        outCol = blendSoftLight(b, f);",
      "    } else if (mode == 9) { // Hard Light",
      "        outCol = blendOverlay(f, b); // Hard Light is Overlay with swapped args",
      "    } else if (mode == 10) { // Difference",
      "        outCol = abs(b - f);",
      "    } else if (mode == 11) { // Exclusion",
      "        outCol = b + f - 2.0 * b * f;",
      "    } else if (mode == 12) { // Add",
      "        outCol = b + f;",
      "    } else if (mode == 13) { // Subtract",
      "        outCol = b - f;",
      "    } else if (mode == 14) { // Divide",
      "        outCol = b / max(f, vec3(0.00001));",
      "}",
      "    ",
      "    // Apply opacity to the foreground influence",
      "    // Standard compositing: Result = BG * (1 - alpha) + Blend(BG, FG) * alpha",
      "    float alpha = fg.a * opacity;",
      "    ",
      "    // Mix based on alpha",
      "    vec3 finalRGB = mix(b, outCol, alpha);",
      "    ",
      "    // Output alpha is usually the union of both",
      "    float finalAlpha = max(bg.a, alpha);",
      "    ",
      "    result = vec4(finalRGB, finalAlpha);",
      "}"
    ],
    "inputs": [
      {
        "id": "background",
        "name": "Background",
        "type": "vec4"
      },
      {
        "id": "foreground",
        "name": "Foreground",
        "type": "vec4"
      },
      {
        "id": "opacity",
        "name": "Opacity",
        "type": "float",
        "default": 1.0
      },
      {
        "id": "mode",
        "name": "Mode",
        "type": "int",
        "default": 0
      }
    ],
    "uniforms": {
      "opacity": {
        "type": "float",
        "value": 1.0,
        "widgetConfig": {
          "min": 0.0,
          "max": 1.0,
          "step": 0.01
        }
      },
      "mode": {
        "type": "int",
        "value": 0,
        "widget": "enum",
        "widgetConfig": {
          "enumOptions": [
            {
              "label": "Normal",
              "value": 0
            },
            {
              "label": "Darken",
              "value": 1
            },
            {
              "label": "Multiply",
              "value": 2
            },
            {
              "label": "Color Burn",
              "value": 3
            },
            {
              "label": "Lighten",
              "value": 4
            },
            {
              "label": "Screen",
              "value": 5
            },
            {
              "label": "Color Dodge",
              "value": 6
            },
            {
              "label": "Overlay",
              "value": 7
            },
            {
              "label": "Soft Light",
              "value": 8
            },
            {
              "label": "Hard Light",
              "value": 9
            },
            {
              "label": "Difference",
              "value": 10
            },
            {
              "label": "Exclusion",
              "value": 11
            },
            {
              "label": "Add",
              "value": 12
            },
            {
              "label": "Subtract",
              "value": 13
            },
            {
              "label": "Divide",
              "value": 14
            }
          ]
        }
      },
      "background": {
        "type": "vec4",
        "value": [
          0,
          0,
          0,
          1
        ],
        "widget": "color"
      },
      "foreground": {
        "type": "vec4",
        "value": [
          1,
          1,
          1,
          1
        ],
        "widget": "color"
      }
    },
    "outputType": "vec4"
  }
}