{
  "id": "REFRACTION_DISPERSION",
  "label": "Refraction & Dispersion",
  "category": "Filter",
  "locales": {
    "zh": {
      "Refraction & Dispersion": "折射与色散",
      "Simulates glass refraction and chromatic aberration using normal maps or radial distortion.": "使用法线贴图或径向畸变模拟玻璃折射和色差效果。",
      "strength": "强度 (IOR)",
      "dispersion": "色散",
      "lens_mode": "透镜模式"
    }
  },
  "data": {
    "glsl": "void run(vec2 uv, sampler2D tex, sampler2D normalMap, float strength, float dispersion, int lens_mode, out vec4 result) {\n    vec2 distortion = vec2(0.0);\n\n    if (lens_mode == 1) {\n        // Radial mode (Lens)\n        vec2 dir = uv - 0.5;\n        float dist = length(dir);\n        // Strength controls how much the edges are pulled/pushed\n        distortion = dir * (dist * strength);\n    } else {\n        // Normal Map mode\n        vec4 normSample = texture(normalMap, uv);\n        // Standard Normal Map: RGB = [0, 1] -> XYZ = [-1, 1]\n        vec3 normal = normalize(normSample.rgb * 2.0 - 1.0);\n        \n        // Use XY for 2D distortion\n        // Scale factor to make 'strength' parameter user-friendly\n        distortion = normal.xy * strength * 0.1;\n    }\n\n    // Chromatic Aberration / Dispersion\n    // We offset R, G, B differently.\n    vec2 offsetR = distortion * (1.0 + dispersion);\n    vec2 offsetG = distortion;\n    vec2 offsetB = distortion * (1.0 - dispersion);\n\n    // Sample texture with offsets\n    float r = texture(tex, uv - offsetR).r;\n    float g = texture(tex, uv - offsetG).g;\n    float b = texture(tex, uv - offsetB).b;\n    \n    // Preserve alpha from the center sample\n    float a = texture(tex, uv - offsetG).a;\n\n    result = vec4(r, g, b, a);\n}",
    "inputs": [
      {
        "id": "tex",
        "name": "tex",
        "type": "sampler2D"
      },
      {
        "id": "normalMap",
        "name": "normalMap",
        "type": "sampler2D"
      },
      {
        "id": "strength",
        "name": "strength",
        "type": "float",
        "default": 0.5,
        "min": -2.0,
        "max": 2.0
      },
      {
        "id": "dispersion",
        "name": "dispersion",
        "type": "float",
        "default": 0.1,
        "min": 0.0,
        "max": 1.0
      },
      {
        "id": "lens_mode",
        "name": "lens_mode",
        "type": "int",
        "default": 0,
        "widget": "toggle"
      }
    ],
    "outputs": [
      {
        "id": "result",
        "name": "result",
        "type": "vec4"
      }
    ],
    "uniforms": {
      "strength": {
        "type": "float",
        "value": 0.5
      },
      "dispersion": {
        "type": "float",
        "value": 0.1
      },
      "lens_mode": {
        "type": "int",
        "value": 0
      }
    }
  }
}
